{% extends "back/base.html" %}
{% load static %}
{% block content %}

<div class="container-fluid mt-4">
    <!-- Notifikasi -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
    <div class="card shadow-lg">
        <div class="row g-0">
            <!-- Foto Siswa -->
            <div class="col-md-4 d-flex align-items-center justify-content-center p-4 bg-light">
                {% if siswa.foto %}
                    <img src="{{ siswa.foto.url }}" class="img-fluid rounded-circle shadow" 
                         style="max-width: 200px;" alt="Foto {{ siswa.nama }}">
                {% else %}
                    <img src="{% static 'dist/img/avatar6.png' %}" class="img-fluid rounded-circle shadow" 
                         style="max-width: 200px;" alt="Default Foto">
                {% endif %}
            </div>

            <!-- Informasi Siswa dan Tabs -->
            <div class="col-md-8">
                <div class="card-body">
                    <h3 class="text-center fw-bold">{{ siswa.nama }}</h3>

                    <!-- Tab Navigation -->
                    <ul class="nav nav-tabs mt-3" id="siswaTabs">
                        <li class="nav-item">
                            <a class="nav-link active" id="profil-tab" data-bs-toggle="tab" href="#profil">Profil</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="nilai-tab" data-bs-toggle="tab" href="#nilai">Daftar Nilai</a>
                        </li>
                        {% if request.session.user_group != 'wali'%}
                        <li class="nav-item">
                            <a class="nav-link" id="status-tab" data-bs-toggle="tab" href="#status">Status & Kelas</a>
                        </li>
                        {% endif %}

                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content mt-3">
                        
                        <!-- Tab Profil Siswa -->
                        <div class="tab-pane fade show active" id="profil">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item"><b>NISN:</b> <span class="float-end">{{ siswa.nisn }}</span></li>
                                <li class="list-group-item"><b>Tanggal Lahir:</b> <span class="float-end">{{ siswa.tanggal_lahir }}</span></li>
                                <li class="list-group-item"><b>Jenis Kelamin:</b> <span class="float-end">{{ siswa.get_jenis_kelamin_display }}</span></li>
                                <li class="list-group-item"><b>Alamat:</b> <span class="float-end">{{ siswa.alamat }}</span></li>
                                <li class="list-group-item"><b>No Telepon:</b> <span class="float-end">{{ siswa.no_telepon }}</span></li>
                                <li class="list-group-item"><b>Kelas Saat ini:</b> <span class="float-end">{{ siswa.kelas_terkini }}</span></li>
                                <li class="list-group-item"><b>Status Saat Ini:</b> 
                                    <span class="float-end">
                                        {% if siswa.status_terkini %}
                                            {% with status=siswa.status_terkini.status %}
                                                <span class="badge 
                                                    {% if status == 'aktif' %}bg-success
                                                    {% elif status == 'naik' %}bg-primary
                                                    {% elif status == 'tinggal' %}bg-warning text-dark
                                                    {% elif status == 'lulus' %}bg-info text-dark
                                                    {% elif status == 'keluar' %}bg-danger
                                                    {% else %}bg-secondary
                                                    {% endif %}
                                                ">
                                                    {{ siswa.status_terkini.get_status_display }}
                                                </span>
                                            {% endwith %}
                                        {% else %}
                                            <span class="text-muted">Tidak ada status</span>
                                        {% endif %}
                                    </span>
                                </li>     
                            </ul>
                        </div>
                        <!-- Tab Profil Siswa -->

                        <!-- Tab Daftar Nilai -->
                        <div class="tab-pane fade" id="nilai">
                            <!-- Filter Form -->
                            <form method="GET" class="mb-3">
                                <div class="row">
                                    <!-- Dropdown Kelas -->
                                    <div class="col-md-4">
                                        <label for="kelas">Kelas:</label>
                                        <select name="kelas" id="kelas" class="form-control">
                                            <option value="">Semua Kelas</option>
                                            {% for k in kelas_list %}
                                                <option value="{{ k.id }}" {% if kelas_id|stringformat:"s" == k.id|stringformat:"s" %}selected{% endif %}>
                                                    {{ k.nama_kelas }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <!-- Dropdown Tahun Ajaran -->
                                    <div class="col-md-4">
                                        <label for="tahun_ajaran">Tahun Ajaran:</label>
                                        <select name="tahun_ajaran" id="tahun_ajaran" class="form-control">
                                            <option value="">Semua Tahun Ajaran</option>
                                            {% for tahun in daftar_tahun_ajaran_list %}
                                                <option value="{{ tahun.id }}" {% if tahun_ajaran_id|stringformat:"s" == tahun.id|stringformat:"s" %}selected{% endif %}>
                                                    {{ tahun.tahun_ajaran }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <!-- Dropdown Semester -->
                                    <div class="col-md-4">
                                        <label for="semester">Semester:</label>
                                        <select name="semester" id="semester" class="form-control">
                                            <option value="">Semua Semester</option>
                                            {% for key, value in semester_choices %}
                                                <option value="{{ key }}" {% if semester_id|stringformat:"s" == key|stringformat:"s" %}selected{% endif %}>
                                                    {{ value }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>

                                <!-- Tombol Filter -->
                                <div class="mt-3 text-end">
                                    <button type="submit" class="btn btn-primary">Filter</button>
                                </div>
                            </form>

                            <!-- Tabel Nilai -->
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead class="table-dark text-white">
                                        <tr>
                                            <th>Mata Pelajaran</th>
                                            <th>Nilai</th>
                                            <th>Predikat</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for rapor in rapor_list %}
                                        <tr>
                                            <td>{{ rapor.mata_pelajaran.nama }}</td>
                                            <td>{{ rapor.nilai }}</td>
                                            <td>
                                                {% if rapor.nilai >= 90 %} A
                                                {% elif rapor.nilai >= 80 %} B
                                                {% elif rapor.nilai >= 70 %} C
                                                {% elif rapor.nilai >= 60 %} D
                                                {% else %} F
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="3" class="text-center">Belum ada nilai</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Tab Daftar Nilai -->

                        <!-- Tab Status & Kelas Siswa -->
                        {% if request.session.user_group != 'wali'%}
                        <div class="tab-pane fade" id="status">
                            <h5 class="fw-bold mb-3">Status & Kelas Siswa</h5>

                            <!-- Form Pindah Kelas -->
                            <form method="POST" action="{% url 'update_kelas_siswa' siswa.id %}" class="mb-4 border p-3 bg-light rounded">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="kelas_baru" class="form-label">Kelas Baru:</label>
                                        <select name="kelas_baru" id="kelas_baru" class="form-control" required>
                                            <option value="">-- Pilih Kelas --</option>
                                            {% for kelas in kelas_list %}
                                                <option value="{{ kelas.id }}">{{ kelas.nama_kelas }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="tahun_ajaran" class="form-label">Tahun Ajaran:</label>
                                        <select name="tahun_ajaran" id="tahun_ajaran" class="form-control" required>
                                            <option value="">-- Pilih Tahun Ajaran --</option>
                                            {% for tahun in daftar_tahun_ajaran_list %}
                                                <option value="{{ tahun.id }}">{{ tahun.tahun_ajaran }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>

                                <div class="text-end mt-3">
                                    <button type="submit" class="btn btn-primary">Simpan</button>
                                </div>
                            </form>

                            <!-- Riwayat Kelas & Status -->
                            <h6 class="fw-bold mb-2">Riwayat Kelas & Status:</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead class="table-secondary">
                                        <tr>
                                            <th>Tahun Ajaran</th>
                                            <th>Kelas</th>
                                            <th>Status</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for status in siswa.status_tahun_ajaran.all %}
                                        <tr>
                                            <td>{{ status.tahun_ajaran.tahun_ajaran }}</td>
                                            <td>{{ status.kelas.nama_kelas }}</td>
                                            <td>
                                                <form method="POST" action="{% url 'update_status_siswa' status.id %}">
                                                    {% csrf_token %}
                                                    <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                                                        {% for key, label in status.STATUS_CHOICES %}
                                                            <option value="{{ key }}" {% if status.status == key %}selected{% endif %}>
                                                                {{ label }}
                                                            </option>
                                                        {% endfor %}
                                                    </select>
                                                </form>

                                            </td>
                                            <td>
                                                    <!-- Tombol Hapus -->
                                                    <form method="POST" action="{% url 'hapus_status_siswa' status.id %}" class="mt-1" onsubmit="return confirm('Yakin ingin menghapus?')">
                                                        {% csrf_token %}
                                                        <button type="submit" class="btn btn-danger btn-sm">Hapus</button>
                                                    </form>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="4" class="text-center">Belum ada riwayat kelas.</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Tab Status & Kelas Siswa -->

                    </div>

                    <!-- Tombol Kembali -->
                    <a href="{% url 'daftar_siswa' %}" class="btn btn-secondary w-100 mt-3">
                        <b>Kembali</b>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock content %}
